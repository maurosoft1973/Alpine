name: Build Alpine

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *' # ogni giorno alle 3:00 UTC

permissions:
  contents: write

jobs:
  find-version:
    runs-on: ubuntu-22.04

    strategy:
      matrix:
        arch: [amd64]

    steps:
      - name: üì¶ Install base dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl jq wget git libssl-dev
          sudo wget https://github.com/benibela/xidel/releases/download/Xidel_0.9.8/xidel_0.9.8-1_amd64.deb
          sudo dpkg -i xidel_0.9.8-1_amd64.deb
          sudo rm  xidel_0.9.8-1_amd64.deb

      - name: üêß Setup for QEmu
        uses: docker/setup-qemu-action@v3
        
      - name: üêß Setup Docker
        uses: docker/setup-buildx-action@v3
        
      - name: üì• Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: üßæ Extracted Alpine Release
        run: |
          sudo chmod +x ./find_alpine_releases.sh
          sudo ./find_alpine_releases.sh

      - name: Download Alpine Version
        run: |
           # Array architetture Alpine
           ALPINE_ARCHITECTURES=("aarch64" "armhf" "armv7" "ppc64le" "x86" "x86_64")
           while IFS= read -r line; do
              # Estrai versione dalla riga (3.22.0)
              ALPINE_VERSION=$(echo "$line" | awk '{print $3}')
              ALPINE_RELEASE=$(echo "$ALPINE_VERSION" | cut -d. -f1,2)  # es. 3.22

              for ALPINE_ARCHITECTURE in "${ALPINE_ARCHITECTURES[@]}"; do
                  OUTDIR="alpine-${ALPINE_VERSION}"
                  OUTFILE="${OUTDIR}/$/alpine-minirootfs-${ALPINE_VERSION}-${ALPINE_ARCHITECTURE}.tar.gz"
                  URL="https://dl-cdn.alpinelinux.org/alpine/v${ALPINE_RELEASE}/releases/${ALPINE_ARCHITECTURE}/alpine-minirootfs-${ALPINE_VERSION}-${ALPINE_ARCHITECTURE}.tar.gz"

                  mkdir -p "$OUTDIR"

                  echo "‚¨áÔ∏è  Scarico: $URL"
                  wget -q --show-progress "$URL" -O "$OUTFILE" || echo "‚ö†Ô∏è  Errore nel download: $URL"
             done
           done < "./alpine_expanded.txt"
    
